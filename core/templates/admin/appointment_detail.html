{% extends "admin/base_admin.html" %}
{% load static %}

{% block title %}Appointment {{ appointment.confirmation_number }} - Admin{% endblock %}

{% block extra_css %}
<style>
  .panel-card {
    border-radius: .5rem;
  }
  .detail-table th {
    width: 40%;
    color: #555;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">

  <!-- Back link -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <a href="{% url 'admin_appointments' %}" class="btn btn-outline-secondary rounded-pill">
      &larr; Back to Appointments
    </a>

    {% if appointment.status == 'PENDING' or appointment.status == 'CONFIRMED' %}
      <button type="button"
              class="btn btn-outline-danger rounded-pill px-4"
              data-bs-toggle="modal"
              data-bs-target="#cancelModal">
        Cancel appointment
      </button>
    {% endif %}
  </div>

  <!-- Header -->
  <div class="p-3 mb-3 panel-card" style="background-color:#e8f2f0;">
    <h1 class="fw-normal m-0" style="font-family: serif; font-size: 2rem;">
      Appointment Details
    </h1>
  </div>

  <div class="row g-4">
    <!-- Appointment Info -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header fw-bold" style="background-color: #C3D5D6;">Appointment</div>
        <div class="card-body">
          <table class="table table-borderless detail-table mb-0">
            <tr>
              <th>Confirmation #</th>
              <td><code>{{ appointment.confirmation_number|default:"--" }}</code></td>
            </tr>
            <tr>
              <th>Start Time</th>
              <td>{{ appointment.start_time|date:"M d, Y g:i A" }}</td>
            </tr>
            <tr>
              <th>Duration</th>
              <td>{{ appointment.duration }}</td>
            </tr>
            <tr>
              <th>Status</th>
              <td>
                <span class="badge
                  {% if appointment.status == 'CONFIRMED' %}bg-success
                  {% elif appointment.status == 'PENDING' %}bg-warning text-dark
                  {% elif appointment.status == 'CANCELLED' %}bg-danger
                  {% elif appointment.status == 'COMPLETED' %}bg-info
                  {% else %}bg-secondary{% endif %}">
                  {{ appointment.get_status_display }}
                </span>
              </td>
            </tr>
            <tr>
              <th>Approved</th>
              <td>{{ appointment.approved|yesno:"Yes,No" }}</td>
            </tr>
            <tr>
              <th>Comments</th>
              <td>{{ appointment.comments|default:"None" }}</td>
            </tr>
            {% if appointment.cancellation_reason %}
            <tr>
              <th>Cancellation Reason</th>
              <td>{{ appointment.cancellation_reason }}</td>
            </tr>
            {% endif %}
            {% if appointment.cancelled_at %}
            <tr>
              <th>Cancelled At</th>
              <td>{{ appointment.cancelled_at|date:"M d, Y g:i A" }}</td>
            </tr>
            {% endif %}
          </table>

          <form method="post" action="{% url 'admin_appointment_update_status' appointment.pk %}" class="mt-3">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <div class="row g-2 align-items-end">
              <div class="col-md-7">
                <label for="statusSelect" class="form-label mb-1">Update status</label>
                <select id="statusSelect" name="status" class="form-select">
                  {% for value, label in status_choices %}
                    <option value="{{ value }}" {% if appointment.status == value %}selected{% endif %}>
                      {{ label }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-5">
                <button type="submit" class="btn text-white rounded-pill w-100" style="background-color: #2d7a73;">
                  Save
                </button>
              </div>
            </div>

            <div id="cancelReasonWrapper" class="mt-2" style="display:none;">
              <label for="statusCancelReason" class="form-label mb-1">Cancellation reason</label>
              <textarea id="statusCancelReason" name="reason" class="form-control" rows="3"></textarea>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Invitee Info -->
    <div class="col-md-6">
      {% for invitee in appointment.invitees.all %}
      <div class="card mb-3">
        <div class="card-header fw-bold" style="background-color: #C3D5D6;">Invitee: {{ invitee.name }}</div>
        <div class="card-body">
          <table class="table table-borderless detail-table mb-0">
            <tr>
              <th>Name</th>
              <td>{{ invitee.name }}</td>
            </tr>
            <tr>
              <th>Email</th>
              <td>{{ invitee.email }}</td>
            </tr>
            <tr>
              <th>Phone</th>
              <td>{{ invitee.phone_number|default:"--" }}</td>
            </tr>
            <tr>
              <th>Status</th>
              <td>{{ invitee.status }}</td>
            </tr>
            <tr>
              <th>Canceled</th>
              <td>{{ invitee.canceled|yesno:"Yes,No" }}</td>
            </tr>
            {% if invitee.cancellation_reason %}
            <tr>
              <th>Cancellation Reason</th>
              <td>{{ invitee.cancellation_reason }}</td>
            </tr>
            {% endif %}
            {% if invitee.reschedule_url %}
            <tr>
              <th>Reschedule URL</th>
              <td><a href="{{ invitee.reschedule_url }}" target="_blank">Link</a></td>
            </tr>
            {% endif %}
          </table>
        </div>
      </div>
      {% empty %}
      <div class="card">
        <div class="card-body text-muted">No invitees recorded for this appointment.</div>
      </div>
      {% endfor %}
    </div>
  </div>

  {% if appointment.status == 'PENDING' or appointment.status == 'CONFIRMED' %}
    <!-- Cancel confirmation modal -->
    <div class="modal fade" id="cancelModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form method="post" action="{% url 'admin_appointment_cancel' appointment.pk %}">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <div class="modal-header">
              <h5 class="modal-title">Cancel appointment?</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p class="mb-2 text-muted">This will set the appointment status to <strong>Cancelled</strong>.</p>
              <label for="reason" class="form-label">Cancellation reason</label>
              <textarea id="reason" name="reason" class="form-control" rows="3" required></textarea>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">Back</button>
              <button type="submit" class="btn text-white rounded-pill px-4" style="background-color: #b02a37;">Confirm cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script>
  (function () {
    const statusSelect = document.getElementById("statusSelect");
    const reasonWrapper = document.getElementById("cancelReasonWrapper");
    const reasonField = document.getElementById("statusCancelReason");
    if (!statusSelect || !reasonWrapper || !reasonField) return;

    function sync() {
      const isCancelled = statusSelect.value === "CANCELLED";
      reasonWrapper.style.display = isCancelled ? "block" : "none";
      reasonField.required = isCancelled;
      if (!isCancelled) reasonField.value = "";
    }

    statusSelect.addEventListener("change", sync);
    sync();
  })();
</script>
{% endblock %}
